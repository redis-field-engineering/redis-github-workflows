name: Gradle Release (Axion)

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        default: '21'
        required: false
        type: string
      version:
        description: 'Release version (e.g., 0.5.1). Leave empty to auto-increment.'
        required: false
        type: string
      version-increment:
        description: 'Version increment type (used if version is not specified)'
        default: 'incrementPatch'
        required: false
        type: string
      gradle-build-tasks:
        description: 'Gradle tasks to run for building distributions'
        default: 'build publish'
        required: false
        type: string
      jreleaser-version:
        description: 'JReleaser version to use'
        default: 'latest'
        required: false
        type: string
      clone-to-dist-repo:
        description: 'Whether to clone release to a -dist repository'
        default: false
        required: false
        type: boolean
      update-antora-version:
        description: 'Whether to update docs/antora.yml version after release'
        default: false
        required: false
        type: boolean
    secrets:
      git-access-token:
        description: 'GitHub token with write access'
        required: true
      gpg-passphrase:
        description: 'GPG passphrase for signing'
        required: true
      gpg-public-key:
        description: 'GPG public key'
        required: true
      gpg-secret-key:
        description: 'GPG secret key'
        required: true
      sonatype-username:
        description: 'Sonatype username for Maven Central'
        required: false
      sonatype-password:
        description: 'Sonatype password for Maven Central'
        required: false
      slack-webhook:
        description: 'Slack webhook URL for notifications'
        required: false

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.git-access-token }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: gradle

      - name: Build and Test
        run: ./gradlew build

      - name: Create Release Tag
        id: create_tag
        env:
          INPUT_VERSION: ${{ inputs.version }}
          INPUT_VERSION_INCREMENT: ${{ inputs.version-increment }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            ./gradlew release -Prelease.version="$INPUT_VERSION"
          else
            ./gradlew release -Prelease.versionIncrementer="$INPUT_VERSION_INCREMENT"
          fi

          # Get the version that was just tagged
          VERSION=$(./gradlew currentVersion -q | grep "Project version:" | cut -d' ' -f3)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Released version: $VERSION"

      - name: Checkout Release Tag
        env:
          RELEASE_VERSION: ${{ steps.create_tag.outputs.version }}
        run: |
          git fetch --tags
          git checkout "v$RELEASE_VERSION"

      - name: Build Distributions
        run: |
          ./gradlew ${{ inputs.gradle-build-tasks }}

      - name: Release with JReleaser
        uses: jreleaser/release-action@v2
        with:
          arguments: full-release
          version: ${{ inputs.jreleaser-version }}
        env:
          JRELEASER_GITHUB_TOKEN: ${{ secrets.git-access-token }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.gpg-passphrase }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.gpg-public-key }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.gpg-secret-key }}
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.sonatype-username }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.sonatype-password }}
          JRELEASER_SLACK_WEBHOOK: ${{ secrets.slack-webhook }}
          JRELEASER_PROJECT_VERSION: ${{ steps.create_tag.outputs.version }}

      - name: JReleaser Output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jreleaser-logs
          path: |
            out/jreleaser/trace.log
            out/jreleaser/output.properties

      - name: Clone release to dist repository
        if: inputs.clone-to-dist-repo
        uses: andrewthetechie/gha-clone-releases@v1
        with:
          token: ${{ secrets.git-access-token }}
          src_repo: ${{ github.repository }}
          dest_repo: ${{ github.repository }}-dist
          copy_assets: true

      - name: Update Antora documentation version
        if: inputs.update-antora-version
        env:
          RELEASE_VERSION: ${{ steps.create_tag.outputs.version }}
        run: |
          # Checkout main branch
          git checkout main
          git pull origin main

          # Check if docs/antora.yml exists
          if [ ! -f "docs/antora.yml" ]; then
            echo "docs/antora.yml not found, skipping version update"
            exit 0
          fi

          # Update version in antora.yml
          sed -i.bak "s/^version:.*/version: $RELEASE_VERSION/" docs/antora.yml
          rm -f docs/antora.yml.bak

          # Check if there are changes
          if git diff --quiet docs/antora.yml; then
            echo "No changes to docs/antora.yml"
            exit 0
          fi

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/antora.yml
          git commit -m "docs: update Antora version to $RELEASE_VERSION"
          git push origin main

          echo "Updated docs/antora.yml to version $RELEASE_VERSION"
